#!/bin/bash
set -e -o pipefail
isdb=$(dirname $0)/..

if [[ -z $1 ]]; then
    echo "usage: $(basename $0) source-name|source-path [additional opts for load-integrations]"
    exit 1
fi
source=$1
shift
[[ $source == . || $source == ./ ]] && source=$PWD
name=$(basename $source)

set -o nounset

if [[ $source == $name ]]; then
    source=$isdb/sources/$name
fi

if ! test -d $source; then
    echo "Error: $source ($name) is not a directory" 2>&1
    exit 2
fi

$isdb/bin/drop-source $name
$isdb/bin/create-source $source/metadata.json
$isdb/bin/load-integrations "$@" $source/transformed.csv
