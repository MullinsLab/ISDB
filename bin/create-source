#!/usr/bin/env perl
use 5.010;
use strict;
use warnings;
use open qw< :std :encoding(UTF-8) >;
use FindBin qw< $Bin $Script >;
use lib "$Bin/../lib", "$Bin/../local/lib/perl5";
use ISDB::Schema;
use ISDB::Types qw< SourceMetadata >;
use JSON::MaybeXS;
use Path::Tiny;

$|++;

my $file = shift
    or die "usage: $Script source[/metadata.json]\n";

$file = path($file);
$file = $file->child("metadata.json")
    if $file->is_dir;

die "No such file $file\n"
    unless $file->is_file;

my $json     = $file->slurp_utf8;
my $metadata = JSON->new->decode($json);
SourceMetadata->assert_valid($metadata);

print "Creating source $metadata->{name}... ";

my $db  = ISDB::Schema->connect_default;
my $txn = $db->txn_scope_guard;
$db->resultset("Source")->create({
    source_name => $metadata->{name},
    document    => $json,
});
$txn->commit;

say "OK";
