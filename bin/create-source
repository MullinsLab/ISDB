#!/usr/bin/env perl
use strict;
use warnings;
use open qw< :std :encoding(UTF-8) >;
use ISDB::Schema;
use JSON::PP;
use Types::Standard qw< :types slurpy >;
use Types::Common::String qw< :types >;

my $SourceMetadata = Dict[
    name    => NonEmptySimpleStr,
    uri     => NonEmptySimpleStr,
    slurpy HashRef
];

my $json     = do { local $/; <> };
my $metadata = decode_json($json);
$SourceMetadata->assert_valid($metadata);

my $db  = ISDB::Schema->connect_default;
my $txn = $db->txn_scope_guard;
$db->resultset("Source")->create({
    source_name => $metadata->{name},
    document    => $json,
});
$txn->commit;
