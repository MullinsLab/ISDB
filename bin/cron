#!/bin/bash
set -e -o pipefail
bin=$(dirname $0)
isdb=$bin/../

# Make our path absolute
pushd $isdb >/dev/null
isdb=$(pwd)
popd >/dev/null

function usage() {
    cat <<.
usage: $(basename $0) [--auto-update] [--commit] <output-directory>
       $(basename $0) --help

  --auto-update     Pulls the ISDB source repo itself before
                    regenerating the website

  --commit          Commits changes to the output directory,
                    assuming it's a git repo

See $isdb/etc/crontab.example for how you might
run this command.
.
}

function auto_update() {
    pushd $isdb >/dev/null
        if git rev-parse --git-dir >/dev/null 2>&1; then
            if [[ -n $(git remote) ]]; then
                # shasum is provided by Digest::SHA, which is a dependency
                sha="$(shasum $0)"

                echo "→ Pulling ISDB repo"
                git pull --rebase

                # Re-exec ourselves if our source changed with the pull
                if shasum -c <<<"$sha" >/dev/null 2>&1; then
                    echo "→ No need to re-run"
                elif [[ -x $0 ]]; then
                    echo "→ Re-running: $0" "$@"
                    popd >/dev/null     # restore cwd
                    exec "$0" "$@"
                else
                    echo "× $0 disappeared, aborting!" >&2
                    exit 1
                fi
            fi
        fi
    popd >/dev/null
}

# We check if we need to auto update first, so that $@ is preserved for
# potential re-exec.
for arg; do
    case "$arg" in
        --auto-update)
            shift
            auto_update "$@"
            ;;
    esac
done

commit=no
for arg; do
    case "$arg" in
        --commit)
            commit=yes
            shift;;
        -h|--help)
            usage
            exit 0;;
        --)
            shift
            break;;
    esac
done

output=$1

if [[ -z $output ]]; then
    usage
    exit 1
fi

if [[ $commit == yes ]]; then
    pushd $output >/dev/null
        if git rev-parse --git-dir >/dev/null 2>&1; then
            if [[ -n $(git remote) ]]; then
                echo "→ Pulling web repo"
                git pull --rebase origin
            fi
        fi
    popd >/dev/null
fi

echo "→ Regenerating website"
$bin/generate-website --compare $output

if [[ $commit == yes ]]; then
    echo "→ Checking for changes to commit"
    pushd $output >/dev/null
        if git rev-parse --git-dir >/dev/null 2>&1; then
            git add -A .
            if [[ -n $(git status --porcelain) ]]; then
                echo "→ Committing changes"
                git status --porcelain
                git commit -m 'archiving updates'
                if [[ -n $(git remote) ]]; then
                    echo "→ Pushing changes"
                    git push origin HEAD
                else
                    echo "× No remote"
                fi
            else
                echo "→ No changes to commit"
            fi
        else
            echo "× Not a git clone"
        fi
    popd >/dev/null
else
    echo "→ Not committing changes (use --commit to do so)"
fi
